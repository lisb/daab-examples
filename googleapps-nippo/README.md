# 日報ボット for Google Workspace

## はじめに
このドキュメントは direct と Google Workspace を連携させた日報ボット (以下、ボット) について、各種設定から実行するまでの手順書となっています。

direct および Google Workspace の両サービスをご利用中であることを前提としています。

## ボット用アカウントと認証情報の準備
### direct
ボット用アカウントを通常のユーザと同じように作成します。

所属する組織の管理ツールからボット用メールアドレスに招待を送信します。
管理ツールのご利用には権限が必要です。お持ちでない方は、契約者もしくは管理者にご連絡下さい。

招待メールを受信したらメールに記載されている URL をクリックしてアカウント登録をしてください。

登録が完了したらボットアカウントで direct にログインし、組織一覧画面から先ほど送信した招待を「承認」します。
ボットのプロフィール情報は右上のドロップダウンメニューにある「プロフィール編集」から変更可能です。

### Google Workspace
Workspace を操作するためのプロジェクトを [Google Cloud Platform コンソール](https://console.cloud.google.com/?hl=ja)から作成します。

1. コンソールを開いてプロジェクトを作成します。
1. プロジェクトを作成後、ナビゲーションメニューから「API とサービス」の「有効な API とサービス」を選択します。
1. 画面上の「＋ API とサービスの有効化」をクリックし、"Google Drive API" を有効にします。
1. 画面左にある「認証情報」をクリックして認証情報管理画面を開きます。
1. 画面上の「＋ 認証情報を作成」から「OAuth クライアント ID」を選択し、画面に従って設定を進めます。
    - このとき「アプリケーションの種類」は "デスクトップアプリ" で作成してください。
1. 作成完了後「JSON をダウンロード」をクリックして認証情報をダウンロードします。
    - このファイルはボットの起動で必要になります。

Google Cloud Platform コンソールの操作に関する詳細はサービス公式のドキュメントをご確認ください。

## 実行環境の準備
[このリポジトリ全体に対する README](../README.md) に従って準備してください。

## サンプルプログラムの準備
このリポジトリを `git clone` して `googleapps-nippo` ディレクトリに移動します。以降はこのディレクトリ内で作業します。

### direct
direct へのアクセスにはアクセストークンが必要です。以下のコマンドを実行し、ボット用のメールアドレスとパスワードを入力します。
```sh
$ daab login
...

Email: bot@example.com
Password: # no echo back
logged in.
```

`.env` ファイルが作成され、その中に `HUBOT_DIRECT_TOKEN` が保存されていれば成功です。

### Google OAuth 2.0
Google Drive へのアクセスの認可には [OAuth 2.0](https://developers.google.com/identity/protocols/oauth2) を使用します。

「[ボット用アカウントと認証情報の準備](#ボット用アカウントと認証情報の準備)」でダウンロードした認証情報 JSON ファイルのパスを以下の環境変数に設定します。
```sh
$ export GWS_CLIENT_SECRET_FILE=/path/to/client_secret.json
```

### Google Apps Script
Drive 上の日報ドキュメントの編集処理には Google Apps Script を利用します。

ボット用の Google アカウントでログイン後、[Apps Script のコンソール](https://script.google.com/home) から新しいプロジェクトを作成し、`"コード.gs"` に `googleapps-nippo.gs` の内容をコピー & ペーストします。

次に API キーを作成 (※ パスワードを決めるときと同様に強力なキーを生成してください) し、先ほど作成したプロジェクトの `"コード.gs"` の 5 行目にある `"your API key"` の部分をそのキーに置換します。
```javascript
  if (apiKey === 'your API key') { // ここの your API key を生成した API キーに変更する
```

Apps Script コンソールに戻り、右上の「デプロイ」ボタンから「新しいデプロイ」を選択します。
表示されたダイアログの左上にある「種類の選択」のギアアイコンをクリックし、「ウェブアプリ」を選択します。

そして「次のユーザーとして実行」を "自分" に、「アクセスできるユーザー」を "全員" とします。
(**注意！：これはサンプル向けの設定です。サンプルコードではリクエストに含まれた API キーを検証することで任意のアクセスをブロックしています。実運用される場合は所属する組織のポリシーに合わせて変更してください。**)

最後に「デプロイ」をクリックするとアクセス用の URL が発行されます。
この URL と先ほど生成した API キーを以下のように環境変数に設定します。
```sh
$ export DAILY_REPORT_API_URL=https://script.google.com/macros/s/.../exec # 発行された URL を指定してください
$ export DAILY_REPORT_API_KEY=Bei1Ha... # 実際に Apps Script へ設定した値と同じ値を指定してください
```

### Google Drive
日報の保存先とテンプレートを Drive 上に作成します。

保存先として「`日報ボット`」というフォルダを作成し、ボット用の Google アカウントでファイルを作成できるように権限を設定してください。

次にこのサンプルに含まれる `日報テンプレート.docx` を Google Drive にアップロードし、一度 Drive 上で開いて Google ドキュメントとして保存します。このときドキュメント名が「`日報テンプレート`」(拡張子無し) になっていることを確認してください。またボット用の Google アカウントでアクセスできるように権限を設定しておいてください。

なお、日報の保存先と参照するテンプレートは以下の環境変数で変更できます。
```sh
$ export DAILY_REPORT_FOLDER_NAME=日報ボット_2022 # 日報ボット → 日報ボット_2022
$ export DAILY_REPORT_TEMPLATE_NAME=日報テンプレート_2022 # 日報テンプレート → 日報テンプレート_2022
```

## サンプルプログラムの実行
はじめに direct 上でボットとのペアトークを作成します。

次に以下のコマンドでボットを起動します。
```sh
$ npm start
```

初回起動の場合は認可のためにブラウザが起動します。ブラウザが起動したらボット用の Google アカウントでログインし、**認可画面の情報に問題がないことを確認した上で**リソースに対するアクセスを認可します。

完了すると `.credentials.json` というファイルが生成されます。次回の起動からはこのファイルに保存された認可情報が使用されます。

## ボットの利用方法
### 日報を作成する
ボットからの質問に従って回答することで日報が完成します。

ボットとのペアトークを新しく作成するか、ボットに話しかけることで作成を開始します。例えば「報告します」「お疲れさま」などをペアトークで日報ボットに話しかけます。
当日2回目以降の日報の作成は既存の日報に追記されていきます。

```
報告します
```

ボットからは以下のようなメッセージが返ってきます。
```
◯◯さん、お疲れ様です。
本日(2014/07/03)はどんな業務をしましたか？
1件1メッセージでお願いします。
```

この後ユーザーが入力した内容は、先頭に `・` (ビュレット) を付けて日報の業務内容欄に追記されていきます。
```
(ユーザ)
マテリアルデザインの調査

(ボット)
他にも業務があれば教えて下さい。
(ない場合は、「。」とだけ入力して下さい)

(ユーザ)
勤怠管理システムで挨拶ボットが使えないか調査

(ボット)
他にも業務があれば教えて下さい。
(ない場合は、「。」とだけ入力して下さい)

(ユーザ)
。
```

目標達成度はセレクトスタンプから選択するか、数字での入力になります。
```
(ボット)
目標達成度はどのくらいですか？
0〜100で教えてください。

(ユーザ)
50
```

所感・学びの入力は業務内容欄への入力と同様ですが、先頭に `#` を付けて追記されていきます。
```
(ボット)
所感・学びを教えて下さい。
メッセージを分けることで複数の報告ができます。

(ユーザ)
開発者が増えるのはいいこと。どこに配属されて何するかは、まだ状況次第

(ボット)
他にも所感・学びがあれば教えて下さい。
(ない場合は、「。」とだけ入力して下さい)

(ユーザ)
。
```

以上のやり取りを終えると日報が作成されます。
```
(ボット)
業務報告を書き込みました。
(ここに日報への URL)
佐藤博文さん、本日の業務、お疲れ様でした。
```

途中で別のトークルームへ行くなどしてトークが中断されたとしても、ボットとのやりとりはそのまま残るので再開に支障はありません。

なお、日報ボットは外出先での移動中といった短い時間に携帯端末から入力することを目的としたものであるため、入力した内容の訂正や清書については最後の URL から Google ドキュメントを開いて編集してください。

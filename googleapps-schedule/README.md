# スケジュールボット for Google Workspace

## はじめに
このドキュメントは direct と Google Workspace を連携させたスケジュールボット (以下、ボット) について、各種設定から実行するまでの手順書となっています。

direct および Google Workspace の両サービスをご利用中であることを前提としています。

## ボット用アカウントと認証情報の準備
### direct
ボット用アカウントを通常のユーザと同じように作成します。

組織の管理ツールから、ボット用メールアドレスに招待メールを送信します。
管理ツールのご利用には権限が必要です。お持ちでない方は、契約者もしくは管理者にご連絡下さい。

組織に招待されると、ボット用メールアドレスにメールが届きます。
メールに記載されているURLをクリックしてアカウント登録手続きをしてください。

[ログインページ](https://direct4b.com/signin)からボット用メールアドレスでログインします。
招待を承認する画面が開きますので、その画面で「承認」を選択してください。
ボットのプロフィール情報は右上のドロップダウンメニューにある「プロフィール編集」から変更可能です。

### Google Workspace
Workspace を操作するためのプロジェクトを [Google Cloud Platform コンソール](https://console.cloud.google.com/?hl=ja)から作成します。

1. コンソールを開いてプロジェクトを作成します。
1. プロジェクトを作成後、ナビゲーションメニューから「API とサービス」の「有効な API とサービス」を選択します。
1. 画面上の「＋ API とサービスの有効化」をクリックし、"Google Calendar API" を有効にします。
1. 画面左にある「認証情報」をクリックして認証情報管理画面を開きます。
1. 画面上の「＋ 認証情報を作成」から「OAuth クライアント ID」を選択し、画面に従って設定を進めます。
    - このとき「アプリケーションの種類」は "デスクトップアプリ" で作成してください。
1. 作成完了後「JSON をダウンロード」をクリックして認証情報をダウンロードします。
    - このファイルはボットの起動で必要になります。

Google Cloud Platform コンソールの操作に関する詳細はサービス公式のドキュメントをご確認ください。

## 実行環境の準備
[このリポジトリ全体に対する README](../README.md) に従って準備してください。

## サンプルプログラムの準備
このリポジトリを `git clone` して `googleapps-schedule` ディレクトリに移動します。以降はこのディレクトリ内で作業します。

### direct
direct へのアクセスにはアクセストークンが必要です。以下のコマンドを実行し、ボット用のメールアドレスとパスワードを入力します。
```sh
$ daab login
...

Email: bot@example.com
Password: # no echo back
logged in.
```

`.env` ファイルが作成され、その中に `HUBOT_DIRECT_TOKEN` が保存されていれば成功です。

### Google OAuth2.0
Workspace リソースへのアクセスには [OAuth2.0](https://developers.google.com/identity/protocols/oauth2) を使用します。

「[ボット用アカウントと認証情報の準備](#ボット用アカウントと認証情報の準備)」でダウンロードした JSON ファイルのパスを以下の環境変数に設定します。
```sh
$ export GWS_CLIENT_SECRET_FILE=/path/to/client_secret.json
```

### カレンダーの共有
ボットが予定を追加・検索するカレンダーは、ボットに話しかける direct ユーザーのメールアドレスと一致する Google アカウントのカレンダーです。例えば、`user@gmail.com` というメールアドレスを持つ direct ユーザーでボットに話しかけている場合、`user@gmail.com` という Google アカウントのカレンダーが操作の対象となります。

上記のカレンダーに対してスケジュールボットが予定を追加・検索できるように共有設定が必要です。「カレンダーの設定」にある「特定のユーザーとの共有」で、スケジュールボットの Google アカウントを「予定の変更」権限で追加してください。

## サンプルプログラムの実行
はじめに direct 上でボットとのペアトークを作成します。

次に以下のコマンドでボットを起動して、
```sh
$ npm start
```

トーク上でボットに「準備開始。」とメッセージします。

ブラウザが起動したらボット用の Google アカウントログインし、**認可確認画面の情報に問題がないことを確認した上で**リソースに対するアクセスを認可します。

ボットから以下のメッセージが返ってきたら準備完了です。
```
認可処理に成功しました。準備完了です。
```

なお上記の処理が完了すると `.credentials.json` というファイルが生成されます。次回の起動からはこちらのファイルに保存された認可情報が使用されます。
